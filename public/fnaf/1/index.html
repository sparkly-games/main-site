<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Five Nights at Freddy's 1</title>
    <link rel="icon" href="favicon.ico" />
    <style>
        html {
            display: block;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow: hidden;
            height: 100%;
        }

        body {
            position: relative;
            background-color: black;
            background-image: url(resources/office.png);
            background-position: center;
            background-size: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            height: 100%;
        }

        a {
            text-decoration: none;
        }

        .selection {
            height: auto;
            min-height: 100vh;
            width: 100%;
            display: flex;
            overflow: hidden;
        }

        .launcher-text {
            position: absolute;
            left: 50%;
            transform: translate(-50%, 0);
            bottom: 2.5vh;
            z-index: 1;
        }

        .vignette {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
        }

        .glitch {
            position: absolute;
            background-image: url(resources/background.gif);
            background-position: center;
            background-size: 50vw;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            opacity: 0.75;
            z-index: -1;
        }

        canvas {
            display: none;
            user-select: none;
        }

        #title {
            position: absolute;
            top: 10vh;
            left: 5vw;
            z-index: 1;
            height: 20vh;
        }

        #animatronic {
            position: absolute;
            top: -5vh;
            right: 7vw;
            height: 120vh;
        }

        .loader {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            left: 50%;
            transform: translate(-50%, 0);
            bottom: 12vh;
            z-index: 1;
            color: white;
            font-family: monospace;
            text-align: center;
            font-weight: lighter;
            width: 85vw;
        }

        .loader h1 {
            margin: 0;
            font-size: 5vw;
        }

        .loader hr{
            margin: 0;
            border: white solid 0.1vw;
            width: 0%;
        }

        .loader h2 {
            margin: 1vh 0;
            font-size: 1.4vw;
        }
    </style>
</head>

<body>
    <canvas id="MMFCanvas" width="1280" height="720"> Your browser does not support Canvas, Please try again.</canvas>
    <div class="selection" id="selection">
        <img id="title" src="resources/title.png">
        <img id="animatronic" src="resources/animatronic.png">
        <div class="loader">
            <h1 id="percentage">0%</h1>
            <hr id="bar">
            <h2 id="stage">STARTING UP...</h2>
        </div>
        <a href="https://discord.gg/xuu8TnSY4b">
            <div class="launcher-text"><img src="resources/launcher-text.png" style="width: 45vw;"></div>
        </a>
    </div>
    <div class="glitch"></div>
    <img src="resources/vignette.png" class="vignette">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
<!--Made by irv77-->
<script>
window.onload = async function() {
    const gametitle = document.title;
    const runtimecanvas = "resources/FNAF1HTML5.cch";
    const map = new Map();

    // Prevent scroll/touch move
    function preventMotion(event) {
        window.scrollTo(0,0);
        event.preventDefault();
        event.stopPropagation();
    }
    window.addEventListener("scroll", preventMotion, false);
    window.addEventListener("touchmove", preventMotion, false);

    // Fullscreen shortcut
    const pressedKeys = {};
    document.addEventListener('keydown', event => {
        pressedKeys[event.key] = true;
        if (pressedKeys['-'] && pressedKeys['=']) {
            document.querySelector('canvas').requestFullscreen();
            delete pressedKeys[event.key];
        }
    });
    document.addEventListener('keyup', (event) => {
        delete pressedKeys[event.key];
    });

    function updateProgress(text, percent) {
        document.title = percent + '% ' + gametitle;
        document.getElementById('percentage').innerHTML = percent + '%';
        document.getElementById('bar').style.width = percent + '%';
        document.getElementById('stage').innerHTML = text;
    }

    // Intercept fetch for resources to use Blob URLs
    async function intercept() {
        const ogfetch = window.fetch;
        window.fetch = async function(input, init) {
            if (typeof input === 'string' && input.startsWith('resources/')) {
                const fileName = input.split('/').pop();
                if (map.has(fileName)) return ogfetch(map.get(fileName), init);
            }
            return ogfetch(input, init);
        };
    }

    // Extract single ZIP
    async function extract() {
        updateProgress('LOADING RESOURCES...', 0);
        const res = await fetch("https://github.com/onlinegames19/main-site/releases/download/fnaf/resources-optimized.zip");
        const arrayBuffer = await res.arrayBuffer();
        const zip = await JSZip.loadAsync(arrayBuffer);
        const files = Object.keys(zip.files).filter(name => !zip.files[name].dir);
        const totalFiles = files.length;

        for (let i = 0; i < totalFiles; i++) {
            const file = zip.files[files[i]];
            const blob = await file.async("blob");
            const url = URL.createObjectURL(blob);
            map.set(files[i], url);
            updateProgress('EXTRACTING RESOURCES...', Math.floor((i+1)/totalFiles*100));
        }
    }

    // Start loader
    async function wedone() {
        await extract();
        await intercept();

        const script = document.createElement('script');
        script.src = 'src/Runtime.js';
        script.onload = () => {
            new Runtime("MMFCanvas", runtimecanvas);
        };

        document.getElementById('MMFCanvas').style.display = 'block';
        document.getElementById('selection').style.display = 'none';
        document.title = gametitle;
        document.head.appendChild(script);
    }

    wedone();
};
</script>
</html>